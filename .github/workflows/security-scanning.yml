# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
# SPDX-License-Identifier: Apache-2.0

---
name: "[Security] Comprehensive Scanning Pipeline"

on:
  schedule:
    # Run weekly security scans on Sundays at 2 AM UTC
    - cron: "0 2 * * 0"
    # Run monthly SBOM generation on the 1st of each month at 2 AM UTC
    - cron: "0 2 1 * *"
  workflow_dispatch:
    inputs:
      containers_filter:
        description: "Comma-separated list of containers to scan"
        required: false
        type: string
  push:
    branches: [main]
    paths:
      # Run security scans when container files change
      - "library/**/Dockerfile"
      - "library/**/docker-compose.yml"
      - "library/**/*.sh"
      - "library/**/prebuildfs/**"
      - "library/**/rootfs/**"
      # Run when workflow changes
      - ".github/workflows/security-scanning.yml"
      # Run when security configs change
      - "config/security/**"
      - ".trivyignore"
  pull_request:
    branches: [main]
    paths:
      # Only scan containers that changed in PRs
      - "library/**/Dockerfile"
      - "library/**/docker-compose.yml"
      - "library/**/*.sh"
      - "library/**/prebuildfs/**"
      - "library/**/rootfs/**"

permissions:
  contents: read
  security-events: write
  id-token: write
  packages: read

# Prevent concurrent security scans to avoid resource conflicts
concurrency:
  group: security-scanning-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  REGISTRY: ghcr.io

jobs:
  # First discover containers to scan
  discover-containers:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      has_changes: ${{ steps.discover.outputs.has_changes }}
      container_count: ${{ steps.discover.outputs.container_count }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0 # Need full history for changed file detection

      - name: Detect changed containers (PR only)
        id: detect-changes
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          echo "Detecting changed containers for PR optimization..."

          # Get changed files
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$changed_files"

          # Extract changed container directories
          changed_containers=()
          while IFS= read -r file; do
            if [[ $file =~ ^library/([^/]+)/([^/]+)/([^/]+)/.*$ ]]; then
              container_path="${BASH_REMATCH[1]}/${BASH_REMATCH[2]}/${BASH_REMATCH[3]}"
              if [[ ! " ${changed_containers[*]} " =~ \ ${container_path}\  ]]; then
                changed_containers+=("${container_path}")
              fi
            fi
          done <<< "$changed_files"

          if [ ${#changed_containers[@]} -eq 0 ]; then
            echo "No container changes detected - will scan all containers"
            echo "changed_containers_filter=" >> "$GITHUB_OUTPUT"
          else
            # Join array with commas
            IFS=',' 
            changed_containers_filter="${changed_containers[*]}"
            echo "Changed containers detected: $changed_containers_filter"
            echo "changed_containers_filter=$changed_containers_filter" >> "$GITHUB_OUTPUT"
          fi

      - name: Discover containers using composite action
        id: discover
        uses: ./.github/actions/discover-containers
        with:
          event_type: ${{ github.event_name }}
          changed_files: ${{ steps.detect-changes.outputs.changed_containers_filter }}
          containers_filter: ${{ github.event.inputs.containers_filter }}
          force_all: ${{ github.event_name == 'schedule' }}
          include_dev_versions: "false" # Security scans focus on production versions
          base_ref: ${{ github.base_ref || 'main' }}

  security-scan:
    runs-on: ubuntu-latest
    needs: discover-containers
    if: needs.discover-containers.outputs.has_changes == 'true'
    timeout-minutes: 30
    strategy:
      # Don't fail fast - we want all scans to complete even if some fail
      fail-fast: false
      # Increase concurrent jobs for faster completion
      max-parallel: 6
      matrix:
        containers: ${{ fromJson(needs.discover-containers.outputs.matrix) }}
        scanner: [trivy]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Log in to Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image exists
        id: check-image
        run: |
          set -euo pipefail
          image="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.containers.app }}:${{ matrix.containers.version }}-${{ matrix.containers.platform }}"
          echo "Checking if image exists: $image"

          if docker manifest inspect "$image" >/dev/null 2>&1; then
            echo "Image exists: $image"
            echo "exists=true" >> "$GITHUB_OUTPUT"
            
            # Check if image was recently scanned (for scheduled runs)
            if [[ "${{ github.event_name }}" == "schedule" ]]; then
              # Get image creation date
              created_date=$(docker manifest inspect "$image" | jq -r '.history[0].v1Compatibility' | jq -r '.created' 2>/dev/null || echo "")
              if [[ -n "$created_date" ]]; then
                created_timestamp=$(date -d "$created_date" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${created_date%.*}" +%s 2>/dev/null || echo "0")
                current_timestamp=$(date +%s)
                age_days=$(( (current_timestamp - created_timestamp) / 86400 ))
                
                # Skip scanning images older than 30 days on scheduled runs
                if [[ $age_days -gt 30 ]]; then
                  echo "Image is $age_days days old - skipping scheduled scan of older image"
                  echo "skip_old_image=true" >> "$GITHUB_OUTPUT"
                else
                  echo "Image is $age_days days old - proceeding with scan"
                  echo "skip_old_image=false" >> "$GITHUB_OUTPUT"
                fi
              else
                echo "skip_old_image=false" >> "$GITHUB_OUTPUT"
              fi
            else
              echo "skip_old_image=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "Image does not exist: $image"
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "skip_old_image=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip scanning - image not found
        if: steps.check-image.outputs.exists == 'false'
        run: |
          echo "⚠️ Skipping security scan for ${{ matrix.containers.app }}:${{ matrix.containers.version }}-${{ matrix.containers.platform }} - image not found in registry"
          echo "This may be expected if the image hasn't been built and pushed yet."

      - name: Skip scanning - old image on scheduled run
        if: steps.check-image.outputs.skip_old_image == 'true'
        run: |
          echo "⚠️ Skipping security scan for ${{ matrix.containers.app }}:${{ matrix.containers.version }}-${{ matrix.containers.platform }} - image is older than 30 days"
          echo "Scheduled scans focus on recently updated images only."

      - name: Run Trivy vulnerability scanner
        if: matrix.scanner == 'trivy' && steps.check-image.outputs.exists == 'true' && steps.check-image.outputs.skip_old_image == 'false'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.containers.app }}:${{ matrix.containers.version }}-${{ matrix.containers.platform }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          timeout: "10m"

      - name: Upload SARIF results
        if: steps.check-image.outputs.exists == 'true' && steps.check-image.outputs.skip_old_image == 'false'
        uses: github/codeql-action/upload-sarif@192325c86100d080feab897ff886c34abd4c83a3 # v3.30.3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-security-scan

      - name: Upload security scan results
        if: always() && steps.check-image.outputs.exists == 'true' && steps.check-image.outputs.skip_old_image == 'false'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: security-scan-results-${{ matrix.containers.app }}-${{ matrix.containers.version }}-${{ matrix.containers.platform }}
          path: trivy-results.sarif

  # Monthly SBOM generation job
  generate-sbom:
    runs-on: ubuntu-latest
    needs: discover-containers
    if: needs.discover-containers.outputs.has_changes == 'true' && github.event_name == 'schedule' && startsWith(github.event.schedule, '0 2 1')
    timeout-minutes: 45
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        containers: ${{ fromJson(needs.discover-containers.outputs.matrix) }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Log in to Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@8e94d75ddd33f69f691467e42275782e4bfefe84 # v0.20.9
        with:
          image: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.containers.app }}:${{ matrix.containers.version }}-${{ matrix.containers.platform }}
          format: spdx-json
          output-file: sbom-${{ matrix.containers.app }}-${{ matrix.containers.version }}-${{ matrix.containers.platform }}.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom-${{ matrix.containers.app }}-${{ matrix.containers.version }}-${{ matrix.containers.platform }}
          path: sbom-${{ matrix.containers.app }}-${{ matrix.containers.version }}-${{ matrix.containers.platform }}.spdx.json
